// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ========== SEMESTER ==========
model Semester {
  id        Int      @id @default(autoincrement())
  name      String   // "Fall 2024", "Spring 2025"
  startDate String
  endDate   String
  isCurrent Boolean  @default(false)
  subjects  Subject[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== SUBJECT (Enhanced) ==========
model Subject {
  id          String   @id @default(uuid())
  name        String
  code        String
  credits     Int
  type        String   // "Theory", "Lab", "Embedded"
  slot        String?  // "A1", "B1+TB1", etc.
  
  // Teacher Info
  teacherName  String?
  teacherEmail String?
  cabinNo      String?
  labRoom      String?
  classRoom    String?
  
  // Marks
  cat1        Float?
  cat2        Float?
  da          Float?  // Digital Assignments (20 marks = 20%)
  fat         Float?
  labInternal Float?
  labFat      Float?
  
  // Relations
  semesterId  Int?
  semester    Semester? @relation(fields: [semesterId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  modules     SyllabusModule[]
}

// ========== SYLLABUS MODULE (New) ==========
model SyllabusModule {
  id        String   @id @default(uuid())
  title     String
  topics    String[] // Array of topics
  status    String   @default("Pending") // "Pending", "InProgress", "Completed"
  order     Int      @default(0)
  
  // Retention Tracking
  lastStudiedAt DateTime?
  reviewCount   Int      @default(0)
  strength      Float    @default(1.0)
  
  subjectId String
  subject   Subject  @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== ASSIGNMENT ==========
model Assignment {
  id          Int      @id @default(autoincrement())
  title       String
  subject     String   // Subject name (for display)
  subjectId   String?  // Link to Subject model
  due         String
  priority    String
  status      String
  platform    String?  // "VTOP", "Google Classroom", "Moodle", "Other"
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== TODO (Enhanced - Todoist Style) ==========
model Todo {
  id          String    @id @default(uuid())
  text        String
  description String?   // Optional longer description
  completed   Boolean   @default(false)
  completedAt DateTime?
  
  // Scheduling
  dueDate     String?   // Date: "2024-12-25"
  dueTime     String?   // Time: "14:30"
  
  // Organization
  priority    Int       @default(4) // 1-4 (P1 = highest priority)
  subjectId   String?   // Link to Subject
  
  // Subtasks (self-referential relation)
  parentId    String?
  parent      Todo?     @relation("Subtasks", fields: [parentId], references: [id], onDelete: Cascade)
  subtasks    Todo[]    @relation("Subtasks")
  
  // Tags relation
  tags        TodoTag[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

// ========== TAG (Site-wide) ==========
model Tag {
  id        String    @id @default(uuid())
  name      String    @unique
  color     String    @default("#6366f1") // Hex color
  
  // Relations to various entities
  todos      TodoTag[]
  projects   ProjectTag[]
  ideas      IdeaTag[]
  snippets   SnippetTag[]
  resources  ResourceTag[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ========== TODO-TAG (Junction) ==========
model TodoTag {
  id      String @id @default(uuid())
  todoId  String
  tagId   String
  todo    Todo   @relation(fields: [todoId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([todoId, tagId])
}

// ========== PROJECT-TAG (Junction) ==========
model ProjectTag {
  id        String  @id @default(uuid())
  projectId Int
  tagId     String
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, tagId])
}

// ========== IDEA-TAG (Junction) ==========
model IdeaTag {
  id      String @id @default(uuid())
  ideaId  String
  tagId   String
  idea    Idea   @relation(fields: [ideaId], references: [id], onDelete: Cascade)
  tag     Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([ideaId, tagId])
}

// ========== SNIPPET-TAG (Junction) ==========
model SnippetTag {
  id        String  @id @default(uuid())
  snippetId String
  tagId     String
  snippet   Snippet @relation(fields: [snippetId], references: [id], onDelete: Cascade)
  tag       Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([snippetId, tagId])
}

// ========== RESOURCE-TAG (Junction) ==========
model ResourceTag {
  id         String   @id @default(uuid())
  resourceId Int
  tagId      String
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)
  tag        Tag      @relation(fields: [tagId], references: [id], onDelete: Cascade)
  
  @@unique([resourceId, tagId])
}


// ========== PROJECT ==========
model Project {
  id          Int          @id @default(autoincrement())
  title       String
  description String
  progress    Int          @default(0)
  status      String
  tech        String       // Stored as comma separated string
  githubUrl   String?      // GitHub repository URL
  updated     String
  tags        ProjectTag[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
}

// ========== SCHEDULE EVENT ==========
model ScheduleEvent {
  id        Int      @id @default(autoincrement())
  title     String
  type      String   // "Class", "Exam", "Study", "Other"
  time      String
  duration  String
  location  String?
  day       String   // "Monday", "2024-12-25", etc.
  subjectId String?  // Optional: link to subject for class events
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== RESOURCE ==========
model Resource {
  id        Int           @id @default(autoincrement())
  title     String
  type      String        // "pdf", "video", "link"
  url       String?
  category  String
  meta      String?       // size, duration, etc.
  subjectId String?       // Optional: link to subject
  syllabusModuleId String? // Optional: link to specific module
  scoutedByAi Boolean     @default(false)
  tags      ResourceTag[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

// ========== USER SETTINGS ==========
model UserSettings {
  id             Int     @id @default(autoincrement())
  displayName    String  @default("Student")
  email          String?
  department     String  @default("CSE")
  currentSemId   Int?
  focusDuration  Int     @default(25) // Pomodoro focus minutes
  breakDuration     Int     @default(5)
  emailNotifications Boolean @default(false)
  notificationEmail String?  // Pomodoro break minutes
}

model Exam {
  id          Int      @id @default(autoincrement())
  title       String // "CAT 1", "FAT"
  subjectId   String? // Optional link to subject
  date        DateTime
  syllabus    String? // Text or JSON for module tracking
  room        String?
  seat        String?
  createdAt   DateTime @default(now())
}

model DailyLog {
  id        Int      @id @default(autoincrement())
  date      DateTime @default(now()) // Only one per day ideally
  mood      Int // 1 (Bad) to 5 (Great)
  note      String? // "Brain dump"
  sleep     Int? // Hours of sleep
  studyTime Int? // Minutes studied
  subjectId String?
}

// ========== LIBRARY TRACKER ==========
model Book {
  id        String   @id @default(uuid())
  title     String
  author    String
  status    String   @default("toread") // "toread", "reading", "completed"
  progress  Int      @default(0)
  total     Int      @default(100)
  dueDate   DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ========== IDEA BOARD ==========
model Idea {
  id        String    @id @default(uuid())
  content   String
  status    String    @default("brainstorm") // "brainstorm", "planned", "done"
  tags      IdeaTag[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ========== SNIPPET LIBRARY ==========
model Snippet {
  id           String       @id @default(uuid())
  title        String
  content      String
  language     String       @default("text") // "text", "javascript", "python", etc.
  type         String       @default("text") // "code", "text"
  legacyTags   String?      // JSON string or comma-separated (deprecated)
  tags         SnippetTag[]
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
}

// ========== NEXT AUTH ==========
model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
